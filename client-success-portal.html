<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INT Client Success Portal</title>
  <link rel="stylesheet" href="/src/styles/client-success.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .portal-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .portal-header {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .portal-title {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }

    .portal-subtitle {
      color: #6b7280;
      font-size: 16px;
    }

    .nav-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: white;
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .nav-tab {
      padding: 12px 24px;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-tab:hover {
      background: #f3f4f6;
    }

    .nav-tab.active {
      background: #2563eb;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="authScreen" style="display: none;">
    <div style="max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
      <h2 style="margin-bottom: 8px; color: #111827;">Welcome Back</h2>
      <p style="color: #6b7280; margin-bottom: 24px;">Sign in to access the Client Success Portal</p>
      <form id="loginForm">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 4px; color: #374151; font-weight: 500;">Email</label>
          <input type="email" id="loginEmail" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" placeholder="you@example.com">
        </div>
        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 4px; color: #374151; font-weight: 500;">Password</label>
          <input type="password" id="loginPassword" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button type="submit" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-bottom: 12px;">Sign In</button>
      </form>
      <button onclick="skipAuth()" style="width: 100%; padding: 12px; background: transparent; color: #6b7280; border: 1px solid #d1d5db; border-radius: 6px; font-weight: 500; cursor: pointer;">Continue as Guest</button>
      <p style="text-align: center; margin-top: 16px; color: #9ca3af; font-size: 13px;">Demo: Use any email/password or skip to guest mode</p>
    </div>
  </div>

  <div id="portalApp" class="portal-container" style="display: none;">
    <div class="portal-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="portal-title">INT Client Success Portal</h1>
        <p class="portal-subtitle">Our Purpose is Your Business | Comprehensive support management with AI-powered insights</p>
      </div>
      <div style="display: flex; gap: 12px; align-items: center;">
        <span id="userDisplay" style="color: #6b7280; font-size: 14px;"></span>
        <button onclick="location.href='/'" style="padding: 8px 16px; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">‚Üê Home</button>
        <button id="logoutBtn" onclick="logout()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">Logout</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="nav-tab" onclick="switchTab('assignment')">Assignment</button>
      <button class="nav-tab" onclick="switchTab('followup')">Follow-Ups</button>
      <button class="nav-tab" onclick="switchTab('templates')">Templates</button>
      <button class="nav-tab" onclick="switchTab('knowledge')">Knowledge Base</button>
      <button class="nav-tab" onclick="switchTab('analytics')">Analytics</button>
      <button class="nav-tab" onclick="switchTab('multichannel')">Multi-Channel</button>
      <button class="nav-tab" onclick="switchTab('forecast')">Forecasting</button>
    </div>

    <div id="dashboard-tab" class="tab-content active">
      <div class="main-grid">
        <div id="ticketDashboard"></div>
        <div id="customerContext"></div>
      </div>
    </div>

    <div id="assignment-tab" class="tab-content">
      <div id="csrAssignment"></div>
    </div>

    <div id="followup-tab" class="tab-content">
      <div id="followUpManager"></div>
    </div>

    <div id="templates-tab" class="tab-content">
      <div id="responseTemplates"></div>
    </div>

    <div id="knowledge-tab" class="tab-content">
      <div id="knowledgeBase"></div>
    </div>

    <div id="analytics-tab" class="tab-content">
      <div id="sentimentAnalytics"></div>
    </div>

    <div id="multichannel-tab" class="tab-content">
      <div id="multiChannelHub"></div>
    </div>

    <div id="forecast-tab" class="tab-content">
      <div id="forecastDashboard"></div>
    </div>
  </div>

  <div id="ticketDetailModal" class="modal" style="display: none;">
    <div class="modal-content modal-xlarge">
      <div id="ticketDetailView"></div>
    </div>
  </div>

  <div id="demoDataPanel" style="position: fixed; bottom: 20px; left: 20px; background: white; padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 999;">
    <button class="btn-secondary btn-small" onclick="window.seedDemoData().then(() => alert('Demo data seeded! Refresh the page.'))">üîß Seed Demo Data</button>
  </div>

  <script type="module">
    import { supabase } from './src/services/supabaseClient.js';
    import { TicketDashboard } from './src/components/TicketDashboard.js';
    import { CustomerContextPanel } from './src/components/CustomerContextPanel.js';
    import { ResponseTemplates } from './src/components/ResponseTemplates.js';
    import { KnowledgeBase } from './src/components/KnowledgeBase.js';
    import { SentimentAnalyticsDashboard } from './src/components/SentimentAnalyticsDashboard.js';
    import { MultiChannelHub } from './src/components/MultiChannelHub.js';
    import { ForecastDashboard } from './src/components/ForecastDashboard.js';
    import { TicketDetailView } from './src/components/TicketDetailView.js';
    import { CSRAssignmentPanel } from './src/components/CSRAssignmentPanel.js';
    import { FollowUpManager } from './src/components/FollowUpManager.js';
    import { notificationCenter } from './src/components/NotificationCenter.js';
    import { ExportUtils } from './src/utils/exportUtils.js';
    import { seedDemoData } from './src/utils/demoData.js';
    import { initAuthFlow } from './src/portal/authFlow.js';

    window.ticketDashboard = new TicketDashboard('ticketDashboard');
    window.customerContextPanel = new CustomerContextPanel('customerContext');
    window.responseTemplates = new ResponseTemplates('responseTemplates');
    window.knowledgeBase = new KnowledgeBase('knowledgeBase');
    window.sentimentAnalytics = new SentimentAnalyticsDashboard('sentimentAnalytics');
    window.multiChannelHub = new MultiChannelHub('multiChannelHub');
    window.forecastDashboard = new ForecastDashboard('forecastDashboard');
    window.csrAssignmentPanel = new CSRAssignmentPanel('csrAssignment');
    window.followUpManager = new FollowUpManager('followUpManager');
    window.notificationCenter = notificationCenter;
    window.ExportUtils = ExportUtils;
    window.seedDemoData = seedDemoData;

    async function initializeComponents() {
      await window.ticketDashboard.init();
      window.notificationCenter.init();
    }

    window.switchTab = function(tabName) {
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');

      const initMap = {
        'assignment': () => window.csrAssignmentPanel.init(),
        'followup': () => window.followUpManager.init(),
        'templates': () => window.responseTemplates.init(),
        'knowledge': () => window.knowledgeBase.init(),
        'analytics': () => window.sentimentAnalytics.init(),
        'multichannel': () => window.multiChannelHub.init(),
        'forecast': () => window.forecastDashboard.init()
      };

      if (initMap[tabName] && !window[`${tabName}Initialized`]) {
        initMap[tabName]();
        window[`${tabName}Initialized`] = true;
      }
    };

    const authController = initAuthFlow({
      supabase,
      document,
      window,
      onPortalReady: () => {
        initializeComponents();
      },
      alertFn: (message) => alert(message)
    });

    window.addEventListener('view-ticket', async (e) => {
      const { ticketId } = e.detail;
      const ticket = window.ticketDashboard.tickets.find(t => t.id === ticketId);
      if (ticket && ticket.customer_id) {
        await window.customerContextPanel.loadCustomerData(ticket.customer_id);
      }
    });

    authController.checkAuth();
  </script>
</body>
</html>
